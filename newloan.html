<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Loan</title>
<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  margin: 0; 
  padding: 0; 
  background: linear-gradient(135deg, #f4f6f8 0%, #e8ecf1 100%); 
  min-height: 100vh;
  line-height: 1.6;
}

nav { 
  background-color: #2c3e50; 
  padding: 12px 20px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
}

.nav-links a { 
  color: #ecf0f1; 
  margin: 0 15px; 
  text-decoration: none; 
  font-weight: bold; 
  font-size: 16px; 
}

.nav-links a:hover { 
  text-decoration: underline; 
  color: #f39c12; 
}

.user-info {
  color: #ecf0f1;
  display: flex;
  align-items: center;
  gap: 15px;
}

.logout-btn {
  background: #e74c3c;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 14px;
}
h1 { text-align: center; margin-top: 25px; color: #34495e; }

form { max-width: 400px; margin: 20px auto; display: flex; flex-direction: column; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
form label { margin-top: 10px; font-weight: bold; }
form input, form button { padding: 10px; margin-top: 5px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
button { cursor: pointer; background-color: #3498db; color: white; border: none; }
button:hover { background-color: #2980b9; }
</style>
</head>
<body>

<nav>
  <div class="nav-links">
    <a href="/">Dashboard</a>
    <a href="/newloan.html" style="color: #f39c12;">New Loan</a>
    <a href="/analysis.html">Analysis</a>
    <a href="/weekly.html">Weekly Payments</a>
    <a href="/borrower_summary.html">Borrower Summary</a>
    <a href="/admin.html" id="admin-link">Admin Panel</a>
  </div>
  <div class="user-info">
    <span id="user-display">Loading...</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</nav>

<!-- Environment Indicator Banner -->
<div id="env-banner" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; text-align: center; padding: 8px 15px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
 ðŸš§ STAGING ENVIRONMENT - Testing Only ðŸš§<br><small>This is a staging site for testing. Your real data is safe on the production site.</small><br><small style="color: #ff6b6b;">ðŸ”„ Test Update: Staging deployment working!</small>
</div>

<h1>New Loan</h1>

<form id="loan-form">
  <label>Borrower ID:</label>
  <input type="text" id="borrower-id" placeholder="Enter Borrower ID" required>

  <label>Borrower Name:</label>
  <input type="text" id="borrower-name" placeholder="Enter Borrower Name" required>

  <label>Loan Amount:</label>
  <input type="number" id="loan-amount" placeholder="Enter Loan Amount" required>

  <label>Interest (%):</label>
  <input type="number" id="loan-interest" placeholder="Enter Interest %" required>

  <label>Weeks:</label>
  <input type="number" id="loan-weeks" placeholder="Enter Number of Weeks" required>

  <label>Start Date:</label>
  <input type="date" id="start-date" required>

  <button type="submit">Add Loan</button>
</form>

<script>
const API_URL = window.location.origin;

document.getElementById("loan-form").onsubmit = async function(e){
    e.preventDefault();

    const borrowerId = document.getElementById("borrower-id").value.trim();
    const borrowerName = document.getElementById("borrower-name").value.trim();
    const amount = parseFloat(document.getElementById("loan-amount").value);
    const interest = parseFloat(document.getElementById("loan-interest").value);
    const weeks = parseInt(document.getElementById("loan-weeks").value);
    const startDate = document.getElementById("start-date").value;

    if(!borrowerId || !borrowerName || !amount || !interest || !weeks || !startDate){
        alert("Please fill all fields");
        return;
    }

    const loanData = {
        borrower_id: borrowerId,
        borrower: borrowerName,
        amount,
        interest,
        weeks,
        start_date: startDate
    };

    try {
        const res = await fetch(`${API_URL}/api/loans`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(loanData)
        });

        if(!res.ok) throw new Error(await res.text());
        const loan = await res.json();
        console.log("Loan added:", loan);
        alert(`Loan added successfully!\nLoan ID: ${loan.id}\nBorrower ID: ${loan.borrower_id}`);
        document.getElementById("loan-form").reset();
    } catch(err) {
        console.error(err);
        alert("Failed to add loan. See console for details.");
    }
};

// Environment detection and banner display
function showEnvironmentBanner(){
    const hostname = window.location.hostname;
    const banner = document.getElementById('env-banner');

    // Show banner on staging/demo environments
    if (hostname.includes('staging') || hostname.includes('preview') || hostname.includes('git-') || hostname.includes('vercel-preview') ||
        (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'staging')) {
        banner.style.display = 'block';
    } else {
        banner.style.display = 'none';
    }
}

// Call on load
window.onload = function(){
    showEnvironmentBanner();
    checkAuth();
};

// Authentication functions
async function checkAuth() {
    try {
        const response = await fetch(`${API_URL}/api/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'check' })
        });
        
        const data = await response.json();
        
        if (!data.authenticated) {
            window.location.href = '/login.html';
            return;
        }
        
        // Update user display
        const userDisplay = document.getElementById('user-display');
        if (userDisplay) {
            userDisplay.textContent = `${data.user.borrower_name || data.user.username} (${data.user.role})`;
        }
        
        // Show/hide admin link based on role
        const adminLink = document.getElementById('admin-link');
        if (adminLink) {
            adminLink.style.display = data.user.role === 'admin' ? 'inline' : 'none';
        }
        
    } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
    }
}

async function logout() {
    try {
        await fetch(`${API_URL}/api/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'logout' })
        });
    } catch (error) {
        console.error('Logout error:', error);
    }
    window.location.href = '/login.html';
}
</script>

</body>
</html>
