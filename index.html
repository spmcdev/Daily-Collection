<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan App - Dashboard</title>
<style>
  body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f4f6f8 0%, #e8ecf1 100%);
      min-height: 100vh;
      line-height: 1.6;
  }
  nav { 
    background-color: #2c3e50; 
    padding: 12px 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
  }
  
  .nav-links a { 
    color: #ecf0f1; 
    margin: 0 15px; 
    text-decoration: none; 
    font-weight: bold; 
    font-size: 16px; 
  }
  
  .nav-links a:hover { 
    text-decoration: underline; 
    color: #f39c12; 
  }
  
  .user-info {
    color: #ecf0f1;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .logout-btn {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
  }

  h1 { text-align: center; margin-top: 25px; color: #34495e; }

  .dashboard-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 20px auto;
      max-width: 1400px;
      padding: 0 10px;
      overflow-x: auto;
  }

  .dashboard-card {
      flex: 0 0 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 10px 8px;
      border-radius: 8px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.15), 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      min-height: 80px;
  }

  .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
  }

  .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(52, 152, 219, 0.2), 0 5px 12px rgba(0,0,0,0.15);
  }

  .dashboard-card h2 {
      margin: 0 0 5px 0;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      opacity: 0.9;
      line-height: 1.1;
  }

  .dashboard-card p {
      font-size: 1.1em;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      line-height: 1.1;
  }

  /* Different visual styles for different card types */
  .dashboard-card:nth-child(1),
  .dashboard-card:nth-child(2) {
      background: linear-gradient(135deg, #3498db, #2980b9);
  }

  .dashboard-card:nth-child(3),
  .dashboard-card:nth-child(4) {
      background: linear-gradient(135deg, #27ae60, #229954);
  }

  .dashboard-card:nth-child(5),
  .dashboard-card:nth-child(6) {
      background: linear-gradient(135deg, #f39c12, #e67e22);
  }


  /* Responsive adjustments - keep single row with scroll */
  @media (max-width: 1000px) {
      .dashboard-card { flex: 0 0 130px; }
      .dashboard-container { gap: 6px; }
  }

  @media (max-width: 768px) {
      .dashboard-card { flex: 0 0 110px; padding: 8px 6px; }
      .dashboard-card h2 { font-size: 0.65em; }
      .dashboard-card p { font-size: 0.95em; }
  }

  .section { max-width: 1200px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
  .section h2 { color: #2c3e50; margin-bottom: 15px; text-align: center; }

  .table-container { overflow-x: auto; margin-top: 10px; }
  table { min-width: 800px; border-collapse: collapse; font-size: 11px; }
  th, td { padding: 4px 3px; text-align: center; border-bottom: 1px solid #ddd; white-space: nowrap; }
  th { background-color: #3498db; color: white; font-weight: 600; font-size: 11px; }

  /* Specific column widths */
  th:nth-child(1), td:nth-child(1) { width: 60px; } /* Loan ID */
  th:nth-child(2), td:nth-child(2) { width: 80px; } /* Borrower ID */
  th:nth-child(3), td:nth-child(3) { width: 120px; } /* Borrower */
  th:nth-child(4), td:nth-child(4) { width: 90px; } /* Amount */
  th:nth-child(5), td:nth-child(5) { width: 80px; } /* Start Date */
  th:nth-child(6), td:nth-child(6) { width: 60px; } /* Interest */
  th:nth-child(7), td:nth-child(7) { width: 50px; } /* Weeks */
  th:nth-child(8), td:nth-child(8) { width: 60px; } /* Paid Weeks */
  th:nth-child(9), td:nth-child(9) { width: 70px; } /* Remaining Weeks */
  th:nth-child(10), td:nth-child(10) { width: 80px; } /* Total Paid */
  th:nth-child(11), td:nth-child(11) { width: 90px; } /* Remaining Amount */
  th:nth-child(12), td:nth-child(12) { width: 90px; } /* Weekly Installment */
  th:nth-child(13), td:nth-child(13) { width: 80px; } /* Next Due Date */
  th:nth-child(14), td:nth-child(14) { width: 80px; } /* Completion Status */
  th:nth-child(15), td:nth-child(15) { width: 100px; } /* Actions */

  /* Hide less important columns on smaller screens */
  @media (max-width: 1200px) {
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8),
    th:nth-child(9), td:nth-child(9),
    th:nth-child(13), td:nth-child(13) { display: none; }
  }

  @media (max-width: 900px) {
    th:nth-child(6), td:nth-child(6),
    th:nth-child(10), td:nth-child(10),
    th:nth-child(11), td:nth-child(11),
    th:nth-child(12), td:nth-child(12) { display: none; }
  }
  tbody tr:nth-child(even) { background-color: #f9f9f9; }
  tbody tr:hover { background-color: #ecf0f1; transition: 0.3s; }

  /* Improved button styling */
  button { padding: 8px 16px; background-color: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
  button:hover { background-color: #c0392b; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  /* Improved search bar styling */
  #search-input { padding: 6px 10px; border: 2px solid #ddd; border-radius: 6px; width: 220px; font-size: 12px; transition: all 0.3s ease; }
  #search-input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1); }

  /* Action buttons in table */
  .action-btn { padding: 3px 8px; font-size: 10px; margin-right: 2px; border-radius: 3px; }
  .edit-btn { background-color: #f39c12; }
  .edit-btn:hover { background-color: #e67e22; }
  .delete-btn { background-color: #e74c3c; }
  .delete-btn:hover { background-color: #c0392b; }
  .export-btn { background-color: #27ae60; padding: 8px 16px; }
  .export-btn:hover { background-color: #229954; }
</style>
</head>
<body>
<nav>
  <div class="nav-links">
    <a href="/">Dashboard</a>
    <a href="/newloan.html">New Loan</a>
    <a href="/analysis.html">Analysis</a>
    <a href="/weekly.html">Weekly Payments</a>
    <a href="/borrower_summary.html">Borrower Summary</a>
    <a href="/admin.html">Admin Panel</a>
  </div>
  <div class="user-info">
    <span id="user-display">Loading...</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</nav>

<!-- Environment Indicator Banner -->
<div id="env-banner" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; text-align: center; padding: 8px 15px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  ðŸš§ STAGING ENVIRONMENT - Testing Only ðŸš§<br><small>This is a staging site for testing. Your real data is safe on the production site.</small><br><small style="color: #ff6b6b;">ðŸ”„ Test Update: Staging deployment working!</small>
</div>

<h1>Dashboard</h1>
<div class="dashboard-container">
  <div class="dashboard-card">
    <h2>Total Principal</h2>
    <p id="total-principal">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Total Interest</h2>
    <p id="total-interest">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Principal Received</h2>
    <p id="principal-received">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Interest Received</h2>
    <p id="interest-received">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Principal Outstanding</h2>
    <p id="principal-outstanding">LKR 0</p>
  </div>
  <div class="dashboard-card">
    <h2>Interest Outstanding</h2>
    <p id="interest-outstanding">LKR 0</p>
  </div>
</div>

<div class="section">
   <h2>Recent Loans</h2>
   <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
       <div>
           <input type="text" id="search-input" placeholder="Search by Borrower ID or Name...">
       </div>
       <div>
           <button onclick="exportToCSV()" class="export-btn">Export to CSV</button>
       </div>
   </div>
   <div class="table-container">
    <table id="loans-table">
      <thead>
        <tr>
          <th>Loan ID</th>
          <th>Borrower ID</th>
          <th>Borrower</th>
          <th>Amount</th>
          <th>Start Date</th>
          <th>Interest %</th>
          <th>Weeks</th>
          <th>Paid Weeks</th>
          <th>Remaining Weeks</th>
          <th>Total Paid</th>
          <th>Remaining Amount</th>
          <th>Weekly Installment</th>
          <th>Next Due Date</th>
          <th>Completion Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
   </div>
</div>

<script>
const API_URL = window.location.origin;

// Utilities
function formatLKR(amount){
    return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Load Dashboard
async function loadDashboard(){
    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    let totalPrincipal = 0;
    let totalInterest = 0;
    let principalReceived = 0;
    let interestReceived = 0;

    loans.forEach(loan => {
        const loanPrincipal = loan.amount;
        const loanInterest = loan.amount * (loan.interest / 100);
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
        const proportionPaid = loan.weeks > 0 ? paidWeeks / loan.weeks : 0;

        totalPrincipal += loanPrincipal;
        totalInterest += loanInterest;
        principalReceived += loanPrincipal * proportionPaid;
        interestReceived += loanInterest * proportionPaid;
    });

    const principalOutstanding = totalPrincipal - principalReceived;
    const interestOutstanding = totalInterest - interestReceived;

    document.getElementById("total-principal").innerText = formatLKR(totalPrincipal);
    document.getElementById("total-interest").innerText = formatLKR(totalInterest);
    document.getElementById("principal-received").innerText = formatLKR(principalReceived);
    document.getElementById("interest-received").innerText = formatLKR(interestReceived);
    document.getElementById("principal-outstanding").innerText = formatLKR(principalOutstanding);
    document.getElementById("interest-outstanding").innerText = formatLKR(interestOutstanding);
}

// Load Loans Table
async function loadLoans(){
    const res = await fetch(`${API_URL}/api/loans`);
    const loans = await res.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    // Sort loans by loan ID descending (latest first)
    loans.sort((a, b) => b.id - a.id);

    const tbody = document.querySelector("#loans-table tbody");
    tbody.innerHTML = "";

    loans.forEach(loan => {
        const weeklyInstallment = (loan.amount*(1 + loan.interest/100)/loan.weeks).toFixed(2);
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
        const remainingWeeks = loan.weeks - paidWeeks;
        const remainingAmount = (weeklyInstallment * remainingWeeks).toFixed(2);
        const totalPaid = (weeklyInstallment * paidWeeks).toFixed(2);

        // Next due date
        let nextDueDate = "-";
        if(remainingWeeks > 0){
            const nextWeekNumber = paidWeeks + 1;
            const dueDateObj = new Date(loan.start_date);
            dueDateObj.setDate(dueDateObj.getDate() + 7 * nextWeekNumber);
            nextDueDate = dueDateObj.toLocaleDateString("si-LK");
        }

        // Smart weekly installment display
        const isCompleted = paidWeeks === loan.weeks;
        const weeklyDisplay = isCompleted ?
            '<span style="color: #27ae60; font-weight: bold;">0</span>' :
            formatLKR(weeklyInstallment);

        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${loan.id}</td>
                        <td>${loan.borrower_id}</td>
                        <td>${loan.borrower}</td>
                        <td>${formatLKR(loan.amount)}</td>
                        <td>${new Date(loan.start_date).toLocaleDateString("si-LK")}</td>
                        <td>${loan.interest}</td>
                        <td>${loan.weeks}</td>
                        <td>${paidWeeks}</td>
                        <td>${remainingWeeks}</td>
                        <td>${formatLKR(totalPaid)}</td>
                        <td>${formatLKR(remainingAmount)}</td>
                        <td>${weeklyDisplay}</td>
                        <td>${nextDueDate}</td>
                        <td style="font-weight: bold; color: ${isCompleted ? '#27ae60' : '#f39c12'};">${isCompleted ? 'Completed' : 'In Progress'}</td>
                        <td>
                            <button onclick="editLoan(${loan.id}, '${loan.borrower_id}', '${loan.borrower}', ${loan.amount}, ${loan.interest}, ${loan.weeks}, '${loan.start_date}')" class="action-btn edit-btn">Edit</button>
                            <button onclick="deleteLoan(${loan.id})" class="action-btn delete-btn">Delete</button>
                        </td>`;
        tbody.appendChild(tr);
    });

    // Initialize search functionality
    initializeSearch();
}

// Edit Loan
function editLoan(id, borrowerId, borrower, amount, interest, weeks, startDate){
    // Create edit modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 1000;
    `;

    modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3>Edit Loan</h3>
            <form id="edit-form">
                <label>Borrower ID:</label>
                <input type="text" id="edit-borrower-id" value="${borrowerId}" required><br><br>

                <label>Borrower Name:</label>
                <input type="text" id="edit-borrower" value="${borrower}" required><br><br>

                <label>Loan Amount:</label>
                <input type="number" id="edit-amount" value="${amount}" required><br><br>

                <label>Interest (%):</label>
                <input type="number" id="edit-interest" value="${interest}" step="0.1" required><br><br>

                <label>Weeks:</label>
                <input type="number" id="edit-weeks" value="${weeks}" required><br><br>

                <label>Start Date:</label>
                <input type="date" id="edit-start-date" value="${startDate}" required><br><br>

                <button type="submit" style="background-color: #27ae60;">Update Loan</button>
                <button type="button" onclick="closeModal()" style="background-color: #95a5a6; margin-left: 10px;">Cancel</button>
            </form>
        </div>
    `;

    document.body.appendChild(modal);

    // Handle form submission
    document.getElementById("edit-form").onsubmit = async function(e){
        e.preventDefault();

        const updatedLoan = {
            borrower_id: document.getElementById("edit-borrower-id").value.trim(),
            borrower: document.getElementById("edit-borrower").value.trim(),
            amount: parseFloat(document.getElementById("edit-amount").value),
            interest: parseFloat(document.getElementById("edit-interest").value),
            weeks: parseInt(document.getElementById("edit-weeks").value),
            start_date: document.getElementById("edit-start-date").value
        };

        try {
            const res = await fetch(`${API_URL}/api/loans/${id}`, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(updatedLoan)
            });

            if(!res.ok) throw new Error(await res.text());
            alert("Loan updated successfully!");
            closeModal();
            loadLoans();
            loadDashboard();
        } catch(err) {
            console.error(err);
            alert("Failed to update loan. See console for details.");
        }
    };
}

// Close modal function
function closeModal(){
    const modal = document.querySelector('div[style*="position: fixed"]');
    if(modal) modal.remove();
}

// Delete Loan
async function deleteLoan(loanId){
    if(!confirm("Are you sure you want to delete this loan?")) return;

    try {
        const res = await fetch(`${API_URL}/api/loans/${loanId}`, { method: "DELETE" });
        const data = await res.json();

        if(res.ok){
            alert("Loan deleted successfully!");
            loadLoans();
            loadDashboard();
        } else {
            alert(`Failed to delete loan: ${data.error || 'Unknown error'}`);
        }
    } catch(error) {
        alert("Network error occurred.");
    }
}

// Export to CSV
async function exportToCSV(){
    const loansRes = await fetch(`${API_URL}/api/loans`);
    const loans = await loansRes.json();
    const paymentsRes = await fetch(`${API_URL}/api/payments`);
    const payments = await paymentsRes.json();

    // Sort loans by loan ID in ascending order (01, 02, 03, etc.)
    loans.sort((a, b) => a.id - b.id);

    let csvContent = "Loan ID,Borrower ID,Borrower,Amount,Start Date,Interest %,Weeks,Paid Weeks,Remaining Weeks,Total Paid,Remaining Amount,Weekly Installment,Next Due Date,Completion Status\n";

    loans.forEach(loan => {
        const weeklyInstallment = (loan.amount*(1 + loan.interest/100)/loan.weeks).toFixed(2);
        const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
        const remainingWeeks = loan.weeks - paidWeeks;
        const remainingAmount = (weeklyInstallment * remainingWeeks).toFixed(2);
        const totalPaid = (weeklyInstallment * paidWeeks).toFixed(2);
        const completionStatus = paidWeeks === loan.weeks ? "Completed" : "In Progress";

        // Next due date
        let nextDueDate = "-";
        if(remainingWeeks > 0){
            const nextWeekNumber = paidWeeks + 1;
            const dueDateObj = new Date(loan.start_date);
            dueDateObj.setDate(dueDateObj.getDate() + 7 * nextWeekNumber);
            nextDueDate = dueDateObj.toLocaleDateString("si-LK");
        }

        csvContent += `${loan.id},${loan.borrower_id},"${loan.borrower}",${loan.amount},${loan.start_date},${loan.interest}%,${loan.weeks},${paidWeeks},${remainingWeeks},${totalPaid},${remainingAmount},${weeklyInstallment},${nextDueDate},${completionStatus}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `loans_export_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}


// Initialize Search Functionality
function initializeSearch(){
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const tableRows = document.querySelectorAll('#loans-table tbody tr');

        tableRows.forEach(row => {
            const borrowerId = row.cells[1].textContent.toLowerCase();
            const borrowerName = row.cells[2].textContent.toLowerCase();

            if (borrowerId.includes(searchTerm) || borrowerName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
}

// Environment detection and banner display
function showEnvironmentBanner(){
    const hostname = window.location.hostname;
    const banner = document.getElementById('env-banner');

    // Show banner on staging/demo environments
    if (hostname.includes('staging') || hostname.includes('preview') || hostname.includes('git-') || hostname.includes('vercel-preview') ||
        (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'staging')) {
        banner.style.display = 'block';
    } else {
        banner.style.display = 'none';
    }
}

// Call both on load
window.onload = function(){
    checkAuth();
    showEnvironmentBanner();
    loadDashboard();
    loadLoans();
};

// Check authentication
async function checkAuth() {
  try {
    const response = await fetch(`${API_URL}/api/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ action: 'check' })
    });
    
    const data = await response.json();
    
    if (!data.authenticated) {
      window.location.href = '/login.html';
      return;
    }
    
    document.getElementById('user-display').textContent = `Welcome, ${data.user.borrower_name} (${data.user.role})`;
  } catch (error) {
    console.error('Auth check error:', error);
    window.location.href = '/login.html';
  }
}

// Logout function
async function logout() {
  try {
    await fetch(`${API_URL}/api/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ action: 'logout' })
    });
  } catch (error) {
    console.error('Logout error:', error);
  } finally {
    window.location.href = '/login.html';
  }
}
</script>
</body>
</html>
