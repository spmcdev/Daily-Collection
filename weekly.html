<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Payments</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; }

/* Modern Navigation */
nav {
    background-color: #2c3e50;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.nav-left {
    display: flex;
    gap: 20px;
}

.nav-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

nav a {
    color: #ecf0f1;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    padding: 8px 12px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

nav a:hover {
    background-color: #34495e;
    color: #f39c12;
}

.user-info {
    color: #ecf0f1;
    font-size: 14px;
    background-color: #34495e;
    padding: 6px 12px;
    border-radius: 4px;
    border: 1px solid #4a6741;
}

#userName {
    font-weight: bold;
    color: #f39c12;
}

.admin-only {
    display: none;
}

.admin-only.visible {
    display: block;
}

h1 { text-align: center; margin-top: 25px; color: #34495e; }

.section { max-width: 1200px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.section h2 { text-align: center; margin-bottom: 15px; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #ddd; }
th { background-color: #3498db; color: white; }
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:hover { background-color: #ecf0f1; transition: 0.3s; }
tbody tr.search-highlight { background-color: #fff3cd !important; border-left: 4px solid #f39c12; }
tbody tr.search-highlight:hover { background-color: #ffeaa7 !important; }

.week-box { padding: 5px; border-radius: 5px; margin: 2px; cursor: pointer; display: inline-block; position: relative; }
.week-box.loading { opacity: 0.7; cursor: not-allowed; }
.paid { background-color: #2ecc71; color: white; }
.unpaid { background-color: #e74c3c; color: white; }
button { cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 5px; padding: 3px 6px; margin-top: 3px; }
button:hover { background-color: #2980b9; }
button:disabled { background-color: #95a5a6; cursor: not-allowed; }

/* Loading spinner */
.loading::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
    margin-left: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

#check-container { text-align: center; margin-bottom: 20px; }
#check-container input { padding: 6px; font-size: 16px; }
#check-container button { padding: 6px 12px; font-size: 16px; }

/* Search bar styling */
.search-container {
    max-width: 600px;
    margin: 20px auto;
    padding: 15px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.search-container input {
    padding: 8px 12px;
    font-size: 16px;
    border: 2px solid #ddd;
    border-radius: 5px;
    width: 300px;
    margin-right: 10px;
    transition: border-color 0.3s ease;
}

.search-container input:focus {
    border-color: #3498db;
    outline: none;
}

.search-container button {
    padding: 8px 16px;
    font-size: 16px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.search-container button:hover {
    background-color: #2980b9;
}

.search-container button.clear-search {
    background-color: #95a5a6;
    margin-left: 10px;
}

.search-container button.clear-search:hover {
    background-color: #7f8c8d;
}

.clear-date-btn {
    background-color: #95a5a6;
    margin-left: 10px;
}

.clear-date-btn:hover {
    background-color: #7f8c8d;
}

.search-results {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
}
</style>
</head>
<body>
<nav>
  <div class="nav-left">
    <a href="/">Home</a>
    <a href="/newloan.html" class="admin-only">New Loan</a>
    <a href="/analysis.html" class="admin-only">Analysis</a>
    <a href="/weekly.html">Weekly Payments</a>
    <a href="/borrower_summary.html">Borrower Summary</a>
  </div>
  <div class="nav-right">
    <span class="user-info">Welcome, <span id="userName">User</span></span>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<!-- Environment Indicator Banner -->
<div id="env-banner" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; text-align: center; padding: 8px 15px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
 ðŸš§ STAGING ENVIRONMENT - Testing Only ðŸš§<br><small>This is a staging site for testing. Your real data is safe on the production site.</small><br><small style="color: #ff6b6b;">ðŸ”„ Test Update: Staging deployment working!</small>
</div>

<h1>Weekly Payments</h1>

<!-- Search Bar -->
<div class="search-container">
    <input type="text" id="search-input" placeholder="Search by Borrower ID or Name..." onkeyup="handleSearch(event)">
    <button onclick="performSearch()">Search</button>
    <button onclick="clearSearch()" class="clear-search">Clear</button>
    <div id="search-results" class="search-results"></div>
</div>

<div id="check-container">
  <input type="date" id="check-date" onchange="checkDueByDate()">
  <button onclick="checkDueByDate()">Check Due By Date</button>
  <button onclick="clearDueTable()" class="clear-date-btn">Clear</button>
</div>

<div class="section">
  <h2>Due Payments</h2>
  <table id="due-table">
    <thead>
      <tr>
        <th>Loan ID</th>
        <th>Borrower ID</th>
        <th>Borrower</th>
        <th>Loan Amount</th>
        <th>Installment Amount</th>
        <th>Due Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section" id="borrowers-container"></div>

<div id="edit-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border:1px solid #ccc; z-index:1000; max-height:80%; overflow:auto;">
  <div id="popup-header" style="cursor: move; background: #f0f0f0; padding: 5px; margin: -20px -20px 10px -20px; border-bottom: 1px solid #ccc;">
    <h3 style="margin: 0;">Edit Payments</h3>
  </div>
  <div id="edit-content"></div>
  <button onclick="closeEdit()">Close</button>
</div>

<script>
const API_URL = window.location.origin;

// Global variables to store original data
let allLoans = [];
let allPayments = [];

// Format currency
function formatLKR(amount){
    return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Search functions
function performSearch(){
    const searchTerm = document.getElementById('search-input').value.trim();
    const resultsDiv = document.getElementById('search-results');

    if (searchTerm === '') {
        clearSearch();
        return;
    }

    // Load and filter data
    loadAllBorrowersHorizontal(searchTerm);

    // Calculate enhanced search results
    const term = searchTerm.toLowerCase().trim();
    const filteredLoans = allLoans.filter(loan =>
        (loan.borrower_id && loan.borrower_id.toLowerCase().includes(term)) ||
        (loan.borrower && loan.borrower.toLowerCase().includes(term))
    );

    // Calculate overdue payments for filtered loans
    let totalOverduePayments = 0;
    filteredLoans.forEach(loan => {
        const paidWeeks = allPayments.filter(p => p.loan_id === loan.id).length;
        // Overdue occurs when borrower hasn't paid all required weeks
        const overdueWeeks = Math.max(0, loan.weeks - paidWeeks);
        totalOverduePayments += overdueWeeks;
        console.log(`Loan ${loan.id}: paidWeeks=${paidWeeks}, totalWeeks=${loan.weeks}, overdueWeeks=${overdueWeeks}`);
    });
    console.log(`Total overdue payments for ${filteredLoans.length} loans: ${totalOverduePayments}`);

    // Check if due date is set and calculate due payments
    const dueDateInput = document.getElementById('check-date').value;
    let duePaymentsCount = 0;
    if (dueDateInput) {
        const targetDate = new Date(dueDateInput);
        console.log(`Checking due payments for date: ${targetDate.toDateString()}`);
        filteredLoans.forEach(loan => {
            const paidWeeks = allPayments.filter(p => p.loan_id === loan.id).length;
            console.log(`Loan ${loan.id}: paidWeeks=${paidWeeks}, totalWeeks=${loan.weeks}`);
            for(let i = paidWeeks + 1; i <= loan.weeks; i++){
                const nextDue = new Date(loan.start_date);
                nextDue.setDate(nextDue.getDate() + 7 * i);
                console.log(`  Week ${i} due date: ${nextDue.toDateString()}`);
                if(nextDue <= targetDate){
                    duePaymentsCount++;
                    console.log(`  -> Due payment found for week ${i}`);
                }
            }
        });
        console.log(`Total due payments by selected date: ${duePaymentsCount}`);
    }

    // Build enhanced results message
    let resultsMessage = `Found ${filteredLoans.length} loan(s) matching "${searchTerm}"`;
    if (totalOverduePayments > 0) {
        resultsMessage += ` â€¢ ${totalOverduePayments} overdue payment(s)`;
    }
    if (dueDateInput && duePaymentsCount > 0) {
        resultsMessage += ` â€¢ ${duePaymentsCount} due by ${new Date(dueDateInput).toLocaleDateString('en-US')}`;
    }

    resultsDiv.innerHTML = resultsMessage;
    resultsDiv.style.color = filteredLoans.length > 0 ? '#27ae60' : '#e74c3c';

    // Update highlighting in due table if it exists
    if (document.querySelector("#due-table tbody").children.length > 0) {
        updateSearchHighlighting(term);
        // Also refresh due table to show updated counts for searched borrowers
        const dueDateInput = document.getElementById('check-date').value;
        if (dueDateInput) {
            checkDueByDate();
        }
    }
}

function clearSearch(){
    document.getElementById('search-input').value = '';
    document.getElementById('search-results').innerHTML = '';
    loadAllBorrowersHorizontal(); // Load all loans

    // Remove highlighting from due table
    const tableRows = document.querySelectorAll('#due-table tbody tr');
    tableRows.forEach(row => {
        row.classList.remove('search-highlight');
    });

    // Clear due table if date is set (to show all loans again)
    const dueDateInput = document.getElementById('check-date').value;
    if (dueDateInput) {
        checkDueByDate();
    }
}

function handleSearch(event){
    if (event.key === 'Enter') {
        performSearch();
    }
}

// Update highlighting without triggering new search
function updateSearchHighlighting(searchTerm){
    const tableRows = document.querySelectorAll('#due-table tbody tr');

    tableRows.forEach(row => {
        // Skip total/empty rows
        if (row.cells.length < 7) return;

        const borrowerId = row.cells[1].textContent.toLowerCase();
        const borrowerName = row.cells[2].textContent.toLowerCase();
        const loanId = row.cells[0].textContent.toLowerCase();

        const matches = borrowerId.includes(searchTerm) ||
                        borrowerName.includes(searchTerm) ||
                        loanId.includes(searchTerm);

        if (matches && searchTerm.trim() !== '') {
            row.classList.add('search-highlight');
        } else {
            row.classList.remove('search-highlight');
        }
    });
}

// Update search results with new due date information
function updateSearchResultsWithDueDate(searchTerm, targetDate){
    const resultsDiv = document.getElementById('search-results');
    const term = searchTerm.toLowerCase().trim();

    // Get filtered loans based on search term
    const filteredLoans = allLoans.filter(loan =>
        (loan.borrower_id && loan.borrower_id.toLowerCase().includes(term)) ||
        (loan.borrower && loan.borrower.toLowerCase().includes(term))
    );

    // Calculate overdue payments for filtered loans
    let totalOverduePayments = 0;
    filteredLoans.forEach(loan => {
        const paidWeeks = allPayments.filter(p => p.loan_id === loan.id).length;
        const overdueWeeks = Math.max(0, loan.weeks - paidWeeks);
        totalOverduePayments += overdueWeeks;
    });

    // Calculate due payments by selected date
    let duePaymentsCount = 0;
    filteredLoans.forEach(loan => {
        const paidWeeks = allPayments.filter(p => p.loan_id === loan.id).length;
        for(let i = paidWeeks + 1; i <= loan.weeks; i++){
            const nextDue = new Date(loan.start_date);
            nextDue.setDate(nextDue.getDate() + 7 * i);
            if(nextDue <= targetDate){
                duePaymentsCount++;
            }
        }
    });

    // Build enhanced results message
    let resultsMessage = `Found ${filteredLoans.length} loan(s) matching "${searchTerm}"`;
    if (totalOverduePayments > 0) {
        resultsMessage += ` â€¢ ${totalOverduePayments} overdue payment(s)`;
    }
    if (duePaymentsCount > 0) {
        resultsMessage += ` â€¢ ${duePaymentsCount} due by ${targetDate.toLocaleDateString('en-US')}`;
    }

    resultsDiv.innerHTML = resultsMessage;
    resultsDiv.style.color = filteredLoans.length > 0 ? '#27ae60' : '#e74c3c';
}

// Load borrowers with weekly boxes
async function loadAllBorrowersHorizontal(searchTerm = ''){
    // Load data only if not already loaded
    if (allLoans.length === 0) {
        const loansRes = await fetch(`${API_URL}/api/loans`);
        allLoans = await loansRes.json();
        const paymentsRes = await fetch(`${API_URL}/api/payments`);
        allPayments = await paymentsRes.json();
    }

    const container = document.getElementById("borrowers-container");
    container.innerHTML = "";

    // Filter loans based on search term
    let filteredLoans = allLoans;
    if (searchTerm.trim() !== '') {
        const term = searchTerm.toLowerCase().trim();
        filteredLoans = allLoans.filter(loan =>
            (loan.borrower_id && loan.borrower_id.toLowerCase().includes(term)) ||
            (loan.borrower && loan.borrower.toLowerCase().includes(term))
        );
    }

    // Sort loans by loan ID descending (latest first)
    filteredLoans.sort((a, b) => b.id - a.id);

    filteredLoans.forEach(loan => {
        const weeklyInstallment = (loan.amount * (1 + loan.interest/100) / loan.weeks).toFixed(2);
        const borrowerDiv = document.createElement("div");
        borrowerDiv.style.marginBottom = "25px";

        const header = document.createElement("div");
        header.innerHTML = `<strong>Loan ID: ${loan.id} | Borrower: ${loan.borrower} | Borrower ID: ${loan.borrower_id || '-'} | Loan Amount: ${formatLKR(loan.amount)}</strong> <button onclick="toggleEdit(${loan.id})">Edit</button>`;
        header.style.marginBottom = "5px";
        borrowerDiv.appendChild(header);

        const weeksDiv = document.createElement("div");
        const startDate = new Date(loan.start_date || new Date());

        for(let i = 1; i <= loan.weeks; i++){
            const paidRecord = allPayments.find(p => p.loan_id === loan.id && p.week === i);
            const weekDiv = document.createElement("div");
            weekDiv.className = "week-box " + (paidRecord ? "paid" : "unpaid");

            const dueDate = new Date(startDate);
            dueDate.setDate(dueDate.getDate() + 7 * i);
            const formattedDate = dueDate.toLocaleDateString("si-LK");

            weekDiv.innerHTML = `${formattedDate}<br>${formatLKR(weeklyInstallment)}`;

            if(!paidRecord){
                weekDiv.onclick = () => markPaidBackend(loan.id, i, weeklyInstallment);
            } else {
                weekDiv.onclick = () => undoPaymentFromBox(paidRecord.id, loan.id, i);
            }

            weeksDiv.appendChild(weekDiv);
        }

        borrowerDiv.appendChild(weeksDiv);
        container.appendChild(borrowerDiv);
    });
}



// Update payment UI locally without reloading all data
function updatePaymentUI(loanId, week, status, paymentId = null) {
    // Find all borrower containers
    const borrowerContainers = document.querySelectorAll('#borrowers-container > div');

    borrowerContainers.forEach(container => {
        const header = container.querySelector('div');
        const loanIdMatch = header.innerHTML.match(/Loan ID: (\d+)/);

        if (loanIdMatch && parseInt(loanIdMatch[1]) === loanId) {
            // Found the right loan container
            const weekBoxes = container.querySelectorAll('.week-box');

            weekBoxes.forEach((box, index) => {
                // Check if this is the week we want to update (index + 1 because weeks start from 1)
                if (index + 1 === week) {
                    if (status === 'paid') {
                        box.className = 'week-box paid';
                        box.style.pointerEvents = 'auto';
                        // Make paid boxes clickable to undo
                        box.onclick = () => undoPaymentFromBox(paymentId, loanId, week);
                        // Restore proper content without button
                        const loan = allLoans.find(l => l.id === loanId);
                        if (loan) {
                            const weeklyAmount = (loan.amount * (1 + loan.interest/100) / loan.weeks).toFixed(2);
                            const startDate = new Date(loan.start_date);
                            const dueDate = new Date(startDate);
                            dueDate.setDate(dueDate.getDate() + 7 * week);
                            const formattedDate = dueDate.toLocaleDateString("si-LK");
                            box.innerHTML = `${formattedDate}<br>${formatLKR(weeklyAmount)}`;
                        }
                    } else if (status === 'unpaid') {
                        box.className = 'week-box unpaid';
                        box.style.pointerEvents = 'auto';
                        // Restore proper content and click handler
                        const loan = allLoans.find(l => l.id === loanId);
                        if (loan) {
                            const weeklyAmount = (loan.amount * (1 + loan.interest/100) / loan.weeks).toFixed(2);
                            const startDate = new Date(loan.start_date);
                            const dueDate = new Date(startDate);
                            dueDate.setDate(dueDate.getDate() + 7 * week);
                            const formattedDate = dueDate.toLocaleDateString("si-LK");
                            box.innerHTML = `${formattedDate}<br>${formatLKR(weeklyAmount)}`;
                            // Re-enable click to mark as paid
                            box.onclick = () => markPaidBackend(loanId, week, weeklyAmount);
                        }
                    }
                }
            });
        }
    });
}

// Mark payment as paid
async function markPaidBackend(loanId, week, amount){
    // Find the week box element and disable it
    const borrowerContainers = document.querySelectorAll('#borrowers-container > div');
    let weekBox = null;

    borrowerContainers.forEach(container => {
        const header = container.querySelector('div');
        const loanIdMatch = header.innerHTML.match(/Loan ID: (\d+)/);

        if (loanIdMatch && parseInt(loanIdMatch[1]) === loanId) {
            const weekBoxes = container.querySelectorAll('.week-box');
            weekBox = weekBoxes[week - 1]; // week is 1-based, array is 0-based
        }
    });

    if (weekBox) {
        weekBox.style.pointerEvents = 'none';
        weekBox.innerHTML = 'Processing...';
        weekBox.classList.add('loading');
    }

    // Update UI to paid immediately
    updatePaymentUI(loanId, week, 'paid');

    try {
        const paymentData = { loan_id: loanId, week, amount };
        const res = await fetch(`${API_URL}/api/payments`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(paymentData)
        });

        if(res.ok){
            const newPayment = await res.json();
            // Update allPayments array
            allPayments.push(newPayment);
            // Refresh the due table if it exists
            if (document.querySelector("#due-table tbody").children.length > 0) {
                checkDueByDate();
            }
        } else {
            alert("Failed to mark payment.");
            // Revert UI to unpaid
            updatePaymentUI(loanId, week, 'unpaid');
        }
    } catch(error) {
        alert("Network error occurred.");
        // Revert UI to unpaid
        updatePaymentUI(loanId, week, 'unpaid');
    } finally {
        // Re-enable the week box and restore proper content
        if (weekBox) {
            weekBox.style.pointerEvents = 'auto';
            weekBox.classList.remove('loading');
            // The updatePaymentUI function should have already restored the proper content
        }
    }
}

// Undo payment
async function undoPayment(paymentId, button = null){
    // Find the loan and week for this payment to update UI
    const borrowerContainers = document.querySelectorAll('#borrowers-container > div');
    let loanId = null;
    let week = null;
    let weekBox = null;

    // If button is provided (from edit popup), find the corresponding week box
    if (button) {
        borrowerContainers.forEach(container => {
            const weekBoxes = container.querySelectorAll('.week-box');
            weekBoxes.forEach((box, index) => {
                if (box.classList.contains('paid')) {
                    const header = container.querySelector('div');
                    const loanIdMatch = header.innerHTML.match(/Loan ID: (\d+)/);
                    if (loanIdMatch) {
                        const currentLoanId = parseInt(loanIdMatch[1]);
                        const currentWeek = index + 1;
                        // Find the payment for this loan and week
                        const payment = allPayments.find(p => p.loan_id === currentLoanId && p.week === currentWeek);
                        if (payment && payment.id === paymentId) {
                            loanId = currentLoanId;
                            week = currentWeek;
                            weekBox = box;
                        }
                    }
                }
            });
        });
    }

    // Disable the button and show loading
    if (button) {
        button.disabled = true;
        button.innerHTML = 'Processing...';
        button.classList.add('loading');
    }
    if (weekBox) {
        weekBox.style.pointerEvents = 'none';
        weekBox.classList.add('loading');
    }

    // Optimistically update UI to unpaid
    if(loanId && week){
        updatePaymentUI(loanId, week, 'unpaid');
    }

    try {
        const res = await fetch(`${API_URL}/api/payments/${paymentId}`, { method: "DELETE" });
        if(res.ok){
            // Remove from allPayments array
            allPayments = allPayments.filter(p => p.id !== paymentId);
            // Refresh the due table if it exists
            if (document.querySelector("#due-table tbody").children.length > 0) {
                checkDueByDate();
            }
            // Refresh edit popup if it's open
            const editPopup = document.getElementById('edit-popup');
            if (editPopup && editPopup.style.display === 'block') {
                // Find the loan ID from the current context
                borrowerContainers.forEach(container => {
                    const header = container.querySelector('div');
                    const loanIdMatch = header.innerHTML.match(/Loan ID: (\d+)/);
                    if (loanIdMatch && parseInt(loanIdMatch[1]) === loanId) {
                        toggleEdit(loanId);
                    }
                });
            }
            // Success - keep button as "Undone" briefly then restore
            if(button){
                setTimeout(() => {
                    button.innerHTML = 'Undo';
                    button.disabled = false;
                    button.classList.remove('loading');
                }, 150); // Further reduced delay from 300ms to 150ms
            }
        } else {
            alert("Failed to undo payment.");
            // Revert UI to paid
            if(loanId && week){
                updatePaymentUI(loanId, week, 'paid', paymentId);
            }
            // Restore button state
            if(button){
                button.innerHTML = 'Undo';
                button.disabled = false;
                button.classList.remove('loading');
            }
        }
    } catch(error) {
        alert("Network error occurred.");
        // Revert UI to paid
        if(loanId && week){
            updatePaymentUI(loanId, week, 'paid', paymentId);
        }
        // Restore button state
        if(button){
            button.innerHTML = 'Undo';
            button.disabled = false;
            button.classList.remove('loading');
        }
    } finally {
        // Re-enable the week box
        if (weekBox) {
            weekBox.style.pointerEvents = 'auto';
            weekBox.classList.remove('loading');
        }
    }
}

// Undo payment from clicking on paid week box
async function undoPaymentFromBox(paymentId, loanId, week){
    const borrowerContainers = document.querySelectorAll('#borrowers-container > div');
    let weekBox = null;

    borrowerContainers.forEach(container => {
        const weekBoxes = container.querySelectorAll('.week-box');
        weekBoxes.forEach((box, index) => {
            if (index + 1 === week) {
                const header = container.querySelector('div');
                const loanIdMatch = header.innerHTML.match(/Loan ID: (\d+)/);
                if (loanIdMatch && parseInt(loanIdMatch[1]) === loanId) {
                    weekBox = box;
                }
            }
        });
    });

    if (!weekBox) return;

    // Disable the box and show loading
    weekBox.style.pointerEvents = 'none';
    weekBox.innerHTML = 'Undoing...';
    weekBox.classList.add('loading');

    try {
        const res = await fetch(`${API_URL}/api/payments/${paymentId}`, { method: "DELETE" });

        if (res.ok) {
            // Remove from allPayments array
            allPayments = allPayments.filter(p => p.id !== paymentId);
            // Update UI to unpaid
            updatePaymentUI(loanId, week, 'unpaid');
            // Refresh the due table if it exists
            if (document.querySelector("#due-table tbody").children.length > 0) {
                checkDueByDate();
            }
        } else {
            alert("Failed to undo payment.");
            // Re-enable the box
            weekBox.style.pointerEvents = 'auto';
            weekBox.classList.remove('loading');
        }
    } catch (error) {
        alert("Network error occurred.");
        // Re-enable the box
        weekBox.style.pointerEvents = 'auto';
        weekBox.classList.remove('loading');
    }
}

// Toggle edit mode for a loan
async function toggleEdit(loanId){
    const editContent = document.getElementById('edit-content');
    editContent.innerHTML = '<p>Loading...</p>';

    // Get fresh data to ensure we have the latest payment status
    if (allPayments.length === 0) {
        const paymentsRes = await fetch(`${API_URL}/api/payments`);
        allPayments = await paymentsRes.json();
    }

    // Find paid payments for this loan
    const paidPayments = allPayments.filter(p => p.loan_id === loanId);

    if(paidPayments.length === 0){
        editContent.innerHTML = '<p>No paid payments to edit.</p>';
    } else {
        let tableHTML = '<table><thead><tr><th>Week</th><th>Amount</th><th>Action</th></tr></thead><tbody>';
        paidPayments.forEach(payment => {
            tableHTML += `<tr><td>${payment.week}</td><td>${formatLKR(payment.amount)}</td><td><button onclick="this.disabled=true; this.innerHTML='Undoing...'; undoPayment(${payment.id}, this)">Undo</button></td></tr>`;
        });
        tableHTML += '</tbody></table>';
        editContent.innerHTML = tableHTML;
    }

    document.getElementById('edit-popup').style.display = 'block';
    // Reset position to center
    const popup = document.getElementById('edit-popup');
    popup.style.left = '50%';
    popup.style.top = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
}

// Close edit popup
function closeEdit(){
    document.getElementById('edit-popup').style.display = 'none';
}

// Dragging functionality
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

document.getElementById('popup-header').addEventListener('mousedown', function(e) {
    e.preventDefault(); // Prevent text selection during drag
    isDragging = true;
    const popup = document.getElementById('edit-popup');
    const rect = popup.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
});

function drag(e) {
    if (!isDragging) return;
    const popup = document.getElementById('edit-popup');
    popup.style.left = (e.clientX - dragOffsetX) + 'px';
    popup.style.top = (e.clientY - dragOffsetY) + 'px';
    popup.style.transform = 'none'; // Remove the center transform
}

function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

// Undo payment by loan and week
async function undoForLoanWeek(loanId, week){
    // Update UI to unpaid
    updatePaymentUI(loanId, week, 'unpaid');

    try {
        // Find the payment for this loan and week
        const payment = allPayments.find(p => p.loan_id === loanId && p.week === week);

        if(payment){
            // Send delete request
            const res = await fetch(`${API_URL}/api/payments/${payment.id}`, { method: "DELETE" });
            if(!res.ok){
                alert("Failed to undo payment.");
                // Revert UI to paid
                updatePaymentUI(loanId, week, 'paid', payment.id);
            }
        } else {
            // Payment not found, reload data to get latest
            loadAllBorrowersHorizontal();
        }
    } catch(error) {
        alert("Network error occurred.");
        // Revert UI to paid
        updatePaymentUI(loanId, week, 'paid');
    }
}


// Mark payment as paid from table
async function markPaidFromTable(loanId, week, amount){
    const button = event.target;
    if (button.disabled) return; // Prevent double-clicking

    button.disabled = true;
    button.innerHTML = 'Processing...';
    button.classList.add('loading');

    // Update main payment boxes immediately
    updatePaymentUI(loanId, week, 'paid');

    try {
        const paymentData = { loan_id: loanId, week, amount };
        const res = await fetch(`${API_URL}/api/payments`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(paymentData)
        });

        if(res.ok){
            const newPayment = await res.json();
            // Update allPayments array
            allPayments.push(newPayment);
            // Refresh the due table to show updated status
            checkDueByDate();
        } else {
            alert("Failed to mark payment.");
            // Revert UI changes
            updatePaymentUI(loanId, week, 'unpaid');
        }
    } catch(error) {
        alert("Network error occurred.");
        // Revert UI changes
        updatePaymentUI(loanId, week, 'unpaid');
    } finally {
        button.disabled = false;
        button.innerHTML = 'Mark Paid';
        button.classList.remove('loading');
    }
}

// Undo payment from table
async function undoPaymentFromTable(paymentId, loanId, week){
    const button = event.target;
    if (button.disabled) return; // Prevent double-clicking

    button.disabled = true;
    button.innerHTML = 'Processing...';
    button.classList.add('loading');

    // Update main payment boxes immediately
    updatePaymentUI(loanId, week, 'unpaid');

    try {
        const res = await fetch(`${API_URL}/api/payments/${paymentId}`, { method: "DELETE" });

        if(res.ok){
            // Remove from allPayments array
            allPayments = allPayments.filter(p => p.id !== paymentId);
            // Refresh the due table to show updated status
            checkDueByDate();
        } else {
            alert("Failed to undo payment.");
            // Revert UI changes
            updatePaymentUI(loanId, week, 'paid', paymentId);
        }
    } catch(error) {
        alert("Network error occurred.");
        // Revert UI changes
        updatePaymentUI(loanId, week, 'paid', paymentId);
    } finally {
        button.disabled = false;
        button.innerHTML = 'Undo Payment';
        button.classList.remove('loading');
    }
}

// Clear the due table
function clearDueTable(){
    document.getElementById("check-date").value = "";
    const tbody = document.querySelector("#due-table tbody");
    tbody.innerHTML = "";

    // Refresh search results to remove due date information
    const searchTerm = document.getElementById('search-input').value.trim();
    if (searchTerm) {
        // Recalculate search results without due date
        const resultsDiv = document.getElementById('search-results');
        const term = searchTerm.toLowerCase().trim();
        const filteredLoans = allLoans.filter(loan =>
            (loan.borrower_id && loan.borrower_id.toLowerCase().includes(term)) ||
            (loan.borrower && loan.borrower.toLowerCase().includes(term))
        );

        // Calculate overdue payments for filtered loans
        let totalOverduePayments = 0;
        filteredLoans.forEach(loan => {
            const paidWeeks = allPayments.filter(p => p.loan_id === loan.id).length;
            const overdueWeeks = Math.max(0, loan.weeks - paidWeeks);
            totalOverduePayments += overdueWeeks;
        });

        // Build results message without due date info
        let resultsMessage = `Found ${filteredLoans.length} loan(s) matching "${searchTerm}"`;
        if (totalOverduePayments > 0) {
            resultsMessage += ` â€¢ ${totalOverduePayments} overdue payment(s)`;
        }

        resultsDiv.innerHTML = resultsMessage;
        resultsDiv.style.color = filteredLoans.length > 0 ? '#27ae60' : '#e74c3c';
    }
}

// Check due installments by selected date and show total
async function checkDueByDate(){
    const dateInput = document.getElementById("check-date").value;
    if(!dateInput) return alert("Please select a date");
    const targetDate = new Date(dateInput);

    const loans = allLoans;
    const payments = allPayments;

    // Get current search term to filter results
    const currentSearchTerm = document.getElementById('search-input').value.trim().toLowerCase();

    const tbody = document.querySelector("#due-table tbody");
    tbody.innerHTML = "";

    let grandTotal = 0;
    let dueInstallments = [];

    // Filter loans based on search term if one exists
    let loansToCheck = loans;
    if (currentSearchTerm.trim() !== '') {
        loansToCheck = loans.filter(loan =>
            (loan.borrower_id && loan.borrower_id.toLowerCase().includes(currentSearchTerm)) ||
            (loan.borrower && loan.borrower.toLowerCase().includes(currentSearchTerm)) ||
            (loan.id && loan.id.toString().includes(currentSearchTerm))
        );
    }

    loansToCheck.forEach(loan => {
        const weeklyAmount = loan.amount * (1 + loan.interest/100) / loan.weeks;
        const paidWeeks = allPayments.filter(p => p.loan_id === loan.id).length;

        for(let i = paidWeeks + 1; i <= loan.weeks; i++){
            const nextDue = new Date(loan.start_date);
            nextDue.setDate(nextDue.getDate() + 7 * i);

            if(nextDue <= targetDate){
                grandTotal += weeklyAmount;
                dueInstallments.push({
                    loanId: loan.id,
                    borrowerId: loan.borrower_id || '-',
                    borrower: loan.borrower,
                    loanAmount: loan.amount,
                    weeklyAmount: weeklyAmount,
                    dueDate: nextDue,
                    week: i
                });
            }
        }
    });

    // Sort by due date
    dueInstallments.sort((a, b) => a.dueDate - b.dueDate);

    // Get current search term
    const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();

    // Display installments with action buttons
    dueInstallments.forEach(installment => {
        const tr = document.createElement("tr");
        const existingPayment = payments.find(p => p.loan_id === installment.loanId && p.week === installment.week);
        const isPaid = !!existingPayment;

        // Check if this installment matches the search term
        const matchesSearch = searchTerm === '' ||
            installment.borrowerId.toLowerCase().includes(searchTerm) ||
            installment.borrower.toLowerCase().includes(searchTerm) ||
            installment.loanId.toString().includes(searchTerm);

        // Add highlight class if it matches search
        if (matchesSearch && searchTerm !== '') {
            tr.classList.add('search-highlight');
        }

        tr.innerHTML = `
            <td>${installment.loanId}</td>
            <td>${installment.borrowerId}</td>
            <td>${installment.borrower}</td>
            <td>${formatLKR(installment.loanAmount)}</td>
            <td>${formatLKR(installment.weeklyAmount)}</td>
            <td>${installment.dueDate.toLocaleDateString("si-LK")}</td>
            <td>
                ${isPaid ?
                    `<button onclick="undoPaymentFromTable(${existingPayment.id}, ${installment.loanId}, ${installment.week})" class="undo-btn">Undo Payment</button>` :
                    `<button onclick="markPaidFromTable(${installment.loanId}, ${installment.week}, ${installment.weeklyAmount})" class="mark-paid-btn">Mark Paid</button>`
                }
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Add total row
    if(grandTotal > 0){
        const trTotal = document.createElement("tr");
        trTotal.innerHTML = `
            <td colspan="3"><strong>Total Due</strong></td>
            <td><strong>${formatLKR(grandTotal)}</strong></td>
            <td colspan="2"><strong>${dueInstallments.length} installments</strong></td>
        `;
        tbody.appendChild(trTotal);
    } else {
        const trEmpty = document.createElement("tr");
        trEmpty.innerHTML = '<td colspan="7" style="text-align: center; color: #27ae60;"><strong>No payments due by selected date! ðŸŽ‰</strong></td>';
        tbody.appendChild(trEmpty);
    }

    // Update highlighting and search results if there's an active search
    const activeSearchTerm = document.getElementById('search-input').value.trim();
    if (activeSearchTerm) {
        updateSearchHighlighting(activeSearchTerm.toLowerCase());
        // Also update the search results to reflect new due date counts
        updateSearchResultsWithDueDate(activeSearchTerm, targetDate);
    }
}

// Load all on page load
window.onload = function(){
    showEnvironmentBanner();
    checkAuth();
    loadAllBorrowersHorizontal(); // Load all loans initially
};

// Environment detection and banner display
function showEnvironmentBanner(){
    const hostname = window.location.hostname;
    const banner = document.getElementById('env-banner');

    // Show banner on staging/demo environments
    if (hostname.includes('staging') || hostname.includes('preview') || hostname.includes('git-') || hostname.includes('vercel-preview') ||
        (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'staging')) {
        banner.style.display = 'block';
    } else {
        banner.style.display = 'none';
    }
}

// Check authentication status
function checkAuth() {
    fetch('/api/auth/verify')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                window.location.href = '/login.html';
                return;
            }
            
            const user = data.user;
            const userNameSpan = document.getElementById('userName');
            
            if (userNameSpan) {
                userNameSpan.textContent = user.username;
            }
            
            // Show admin features if user is admin
            if (user.role === 'admin') {
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => el.classList.add('visible'));
            }
        })
        .catch(error => {
            console.error('Auth check failed:', error);
            window.location.href = '/login.html';
        });
}

// Logout function
function logout() {
    fetch('/api/auth/logout', { method: 'POST' })
        .then(() => {
            window.location.href = '/login.html';
        })
        .catch(error => {
            console.error('Logout failed:', error);
            window.location.href = '/login.html';
        });
}
</script>
</body>
</html>
