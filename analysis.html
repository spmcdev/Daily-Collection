<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Analysis</title>
<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  margin: 0; 
  padding: 0; 
  background: linear-gradient(135deg, #f4f6f8 0%, #e8ecf1 100%); 
  min-height: 100vh;
  line-height: 1.6;
}

nav { 
  background-color: #2c3e50; 
  padding: 12px 20px; 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
}

.nav-links a { 
  color: #ecf0f1; 
  margin: 0 15px; 
  text-decoration: none; 
  font-weight: bold; 
  font-size: 16px; 
}

.nav-links a:hover { 
  text-decoration: underline; 
  color: #f39c12; 
}

.user-info {
  color: #ecf0f1;
  display: flex;
  align-items: center;
  gap: 15px;
}

.logout-btn {
  background: #e74c3c;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 14px;
}
h1 { text-align: center; margin-top: 25px; color: #34495e; }
.section { max-width: 1200px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.section h2 { text-align: center; margin-bottom: 20px; }
.chart-container { width: 100%; max-width: 900px; margin: 20px auto; }
.summary-boxes { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
.summary-box { flex: 1 1 200px; padding: 20px; border-radius: 10px; color: white; text-align: center; font-weight: bold; background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.summary-box p { font-size: 1.3em; margin: 10px 0 0 0; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #ddd; }
th { background-color: #3498db; color: white; }
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:hover { background-color: #ecf0f1; transition: 0.3s; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav>
  <div class="nav-links">
    <a href="/">Dashboard</a>
    <a href="/newloan.html">New Loan</a>
    <a href="/analysis.html" style="color: #f39c12;">Analysis</a>
    <a href="/weekly.html">Weekly Payments</a>
    <a href="/borrower_summary.html">Borrower Summary</a>
    <a href="/admin.html" id="admin-link">Admin Panel</a>
  </div>
  <div class="user-info">
    <span id="user-display">Loading...</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</nav>

<!-- Environment Indicator Banner -->
<div id="env-banner" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; text-align: center; padding: 8px 15px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
üöß STAGING ENVIRONMENT - Testing Only üöß<br><small>This is a staging site for testing. Your real data is safe on the production site.</small><br><small style="color: #ff6b6b;">üîÑ Test Update: Staging deployment working!</small>
</div>

<h1>Advanced Loan Analysis</h1>


<div class="section">
  <h2>Profit & Loss Analysis</h2>

  <!-- Earned Section -->
  <h3 style="color: #27ae60; margin-top: 20px;">üí∞ Earned (Received)</h3>
  <div class="summary-boxes">
    <div class="summary-box" style="background: linear-gradient(135deg, #27ae60, #229954);">
      Principal Received
      <p id="principal-received">LKR 0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
      Interest Earned
      <p id="interest-earned">LKR 0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #16a085, #119e7a);">
      Total Earned
      <p id="total-earned">LKR 0</p>
    </div>
  </div>

  <!-- Mini Summary for Earned Section -->
  <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #27ae60;">
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
      <div style="text-align: center; font-size: 12px;">
        <strong>Avg Rate:</strong><br><span id="earned-avg-rate" style="color: #27ae60;">0%</span>
      </div>
      <div style="text-align: center; font-size: 12px;">
        <strong>Monthly:</strong><br><span id="earned-monthly-rate" style="color: #27ae60;">0%</span>
      </div>
      <div style="text-align: center; font-size: 12px;">
        <strong>Profit/100k:</strong><br><span id="earned-profit-100k" style="color: #27ae60;">LKR 0</span>
      </div>
    </div>
  </div>

  <!-- Remaining Section -->
  <h3 style="color: #f39c12; margin-top: 30px;">‚è≥ Remaining (Outstanding)</h3>
  <div class="summary-boxes">
    <div class="summary-box" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
      Principal Outstanding
      <p id="principal-outstanding">LKR 0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #e67e22, #d35400);">
      Interest Outstanding
      <p id="interest-outstanding">LKR 0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #d35400, #a04000);">
      Total Outstanding
      <p id="total-outstanding">LKR 0</p>
    </div>
  </div>

  <!-- Mini Summary for Remaining Section -->
  <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #f39c12;">
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
      <div style="text-align: center; font-size: 12px;">
        <strong>Avg Rate:</strong><br><span id="remaining-avg-rate" style="color: #f39c12;">0%</span>
      </div>
      <div style="text-align: center; font-size: 12px;">
        <strong>Monthly:</strong><br><span id="remaining-monthly-rate" style="color: #f39c12;">0%</span>
      </div>
      <div style="text-align: center; font-size: 12px;">
        <strong>Profit/100k:</strong><br><span id="remaining-profit-100k" style="color: #f39c12;">LKR 0</span>
      </div>
    </div>
  </div>

  <!-- Expected Section -->
  <h3 style="color: #9b59b6; margin-top: 30px;">üéØ Expected (Total Potential)</h3>
  <div class="summary-boxes">
    <div class="summary-box" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
      Total Principal
      <p id="total-principal">LKR 0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #8e44ad, #732d91);">
      Total Interest Expected
      <p id="total-interest-expected">LKR 0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #732d91, #5b248f);">
      Total Expected Amount
      <p id="total-expected">LKR 0</p>
    </div>
  </div>

  <!-- Mini Summary for Expected Section -->
  <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9b59b6;">
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
      <div style="text-align: center; font-size: 12px;">
        <strong>Avg Rate:</strong><br><span id="expected-avg-rate" style="color: #9b59b6;">0%</span>
      </div>
      <div style="text-align: center; font-size: 12px;">
        <strong>Monthly:</strong><br><span id="expected-monthly-rate" style="color: #9b59b6;">0%</span>
      </div>
      <div style="text-align: center; font-size: 12px;">
        <strong>Profit/100k:</strong><br><span id="expected-profit-100k" style="color: #9b59b6;">LKR 0</span>
      </div>
    </div>
  </div>

  <!-- Summary Section -->
  <h3 style="color: #34495e; margin-top: 30px;">üìä Summary & Rates</h3>
  <div class="summary-boxes">
    <div class="summary-box" style="background: linear-gradient(135deg, #3498db, #2980b9);">
      Average Interest Rate
      <p id="avg-interest-rate">0%</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #2980b9, #1f4e79);">
      Monthly Rate
      <p id="monthly-rate">0%</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #1f4e79, #0f2a4a);">
      Profit on LKR 100,000
      <p id="profit-on-100k">LKR 0</p>
    </div>
  </div>
</div>

<div class="section">
  <h2>Top Borrowers by Amount</h2>
  <table id="topBorrowersTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Borrower ID</th>
        <th>Borrower Name</th>
        <th>Loan Amount</th>
        <th>Interest Rate</th>
        <th>Total Amount</th>
        <th>Paid Amount</th>
        <th>Outstanding</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section chart-container">
  <h2>Paid vs Unpaid Installments</h2>
  <canvas id="paidUnpaidChart"></canvas>
</div>


<div class="section">
  <h2>Overdue Payments (Not Completed on Time)</h2>
  <div style="margin-bottom: 15px;">
    <label for="overdue-date">Check Overdue as of Date:</label>
    <input type="date" id="overdue-date" style="margin-left: 10px; padding: 5px;">
    <button onclick="checkOverdue()" style="margin-left: 10px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px;">Check</button>
  </div>
  <table id="overdueTable">
    <thead>
      <tr>
        <th>Borrower ID</th>
        <th>Borrower Name</th>
        <th>Due Date</th>
        <th>Days Overdue</th>
        <th>Outstanding Amount</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <h2>Detailed Paid vs Unpaid Installments</h2>
  <div class="summary-boxes" style="margin-bottom: 20px;">
    <div class="summary-box" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
      Total Paid Installments
      <p id="total-paid-installments">0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
      Total Unpaid Installments
      <p id="total-unpaid-installments">0</p>
    </div>
    <div class="summary-box" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
      Overall Completion Rate
      <p id="completion-rate">0%</p>
    </div>
  </div>
  <table id="installmentsTable">
    <thead>
      <tr>
        <th>Borrower ID</th>
        <th>Borrower Name</th>
        <th>Total Weeks</th>
        <th>Paid Weeks</th>
        <th>Unpaid Weeks</th>
        <th>Completion %</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const API_URL = window.location.origin;

function formatLKR(amount){
  return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Load summary data
async function loadSummary(){
  const loansRes = await fetch(`${API_URL}/api/loans`);
  const loans = await loansRes.json();
  const paymentsRes = await fetch(`${API_URL}/api/payments`);
  const payments = await paymentsRes.json();

  // Initialize all calculation variables
  let totalPrincipal = 0;
  let totalInterestExpected = 0;
  let principalReceived = 0;
  let interestEarned = 0;
  let principalOutstanding = 0;
  let interestOutstanding = 0;

  loans.forEach(loan => {
    const loanPrincipal = loan.amount;
    const loanInterest = loan.amount * (loan.interest / 100);
    const totalLoanAmount = loanPrincipal + loanInterest;
    const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
    const paidAmount = paidWeeks * (totalLoanAmount / loan.weeks);
    const paidPrincipal = loanPrincipal * (paidWeeks / loan.weeks);
    const paidInterest = paidAmount - paidPrincipal;

    // Expected amounts
    totalPrincipal += loanPrincipal;
    totalInterestExpected += loanInterest;

    // Earned amounts
    principalReceived += paidPrincipal;
    interestEarned += paidInterest;

    // Outstanding amounts
    principalOutstanding += loanPrincipal - paidPrincipal;
    interestOutstanding += loanInterest - paidInterest;
  });

  // Calculate totals
  const totalEarned = principalReceived + interestEarned;
  const totalOutstanding = principalOutstanding + interestOutstanding;
  const totalExpected = totalPrincipal + totalInterestExpected;

  // Calculate rates
  const avgInterestRate = loans.length > 0 ? loans.reduce((sum, loan) => sum + loan.interest, 0) / loans.length : 0;
  const monthlyRate = avgInterestRate / 12;
  const profitOn100k = (100000 * avgInterestRate) / 100;

  // Update all display elements
  // Earned Section
  document.getElementById("principal-received").innerText = formatLKR(principalReceived);
  document.getElementById("interest-earned").innerText = formatLKR(interestEarned);
  document.getElementById("total-earned").innerText = formatLKR(totalEarned);

  // Remaining Section
  document.getElementById("principal-outstanding").innerText = formatLKR(principalOutstanding);
  document.getElementById("interest-outstanding").innerText = formatLKR(interestOutstanding);
  document.getElementById("total-outstanding").innerText = formatLKR(totalOutstanding);

  // Expected Section
  document.getElementById("total-principal").innerText = formatLKR(totalPrincipal);
  document.getElementById("total-interest-expected").innerText = formatLKR(totalInterestExpected);
  document.getElementById("total-expected").innerText = formatLKR(totalExpected);

  // Summary Section
  document.getElementById("avg-interest-rate").innerText = avgInterestRate.toFixed(2) + "%";
  document.getElementById("monthly-rate").innerText = monthlyRate.toFixed(2) + "%";
  document.getElementById("profit-on-100k").innerText = formatLKR(profitOn100k);

  // Mini summaries for each section
  document.getElementById("earned-avg-rate").innerText = avgInterestRate.toFixed(2) + "%";
  document.getElementById("earned-monthly-rate").innerText = monthlyRate.toFixed(2) + "%";
  document.getElementById("earned-profit-100k").innerText = formatLKR(profitOn100k);

  document.getElementById("remaining-avg-rate").innerText = avgInterestRate.toFixed(2) + "%";
  document.getElementById("remaining-monthly-rate").innerText = monthlyRate.toFixed(2) + "%";
  document.getElementById("remaining-profit-100k").innerText = formatLKR(profitOn100k);

  document.getElementById("expected-avg-rate").innerText = avgInterestRate.toFixed(2) + "%";
  document.getElementById("expected-monthly-rate").innerText = monthlyRate.toFixed(2) + "%";
  document.getElementById("expected-profit-100k").innerText = formatLKR(profitOn100k);

  return {loans, payments};
}

// Top borrowers table (replacing chart)
function renderTopBorrowersTable(loans, payments) {
  const tbody = document.querySelector('#topBorrowersTable tbody');
  tbody.innerHTML = '';

  const sortedLoans = loans
    .map(loan => {
      const totalAmount = loan.amount * (1 + loan.interest/100);
      const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
      const paidAmount = paidWeeks * (totalAmount / loan.weeks);
      const outstandingAmount = totalAmount - paidAmount;
      const isCompleted = paidWeeks >= loan.weeks;

      return {
        ...loan,
        totalAmount,
        paidAmount,
        outstandingAmount,
        isCompleted
      };
    })
    .sort((a, b) => b.totalAmount - a.totalAmount)
    .slice(0, 10);

  sortedLoans.forEach((loan, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${loan.borrower_id}</td>
      <td>${loan.borrower}</td>
      <td>${formatLKR(loan.amount)}</td>
      <td>${loan.interest}%</td>
      <td>${formatLKR(loan.totalAmount)}</td>
      <td>${formatLKR(loan.paidAmount)}</td>
      <td>${formatLKR(loan.outstandingAmount)}</td>
      <td style="font-weight: bold; color: ${loan.isCompleted ? '#27ae60' : '#f39c12'};">${loan.isCompleted ? 'Completed' : 'In Progress'}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Paid vs unpaid chart
function renderPaidUnpaid(loans, payments){
  let paid = 0, unpaid = 0;
  loans.forEach(loan=>{
    paid += payments.filter(p=>p.loan_id===loan.id).length;
    unpaid += loan.weeks - payments.filter(p=>p.loan_id===loan.id).length;
  });

  new Chart(document.getElementById('paidUnpaidChart'), {
    type: 'pie',
    data: {
      labels:['Paid','Unpaid'],
      datasets:[{ data:[paid, unpaid], backgroundColor:['#2ecc71','#e74c3c'] }]
    },
    options:{ responsive:true }
  });
}

async function initAnalysis(){
  const {loans, payments} = await loadSummary();
  renderTopBorrowersTable(loans, payments);
  renderPaidUnpaid(loans, payments);
  renderInstallmentsTable(loans, payments);

  // Set default date for overdue check
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('overdue-date').value = today;
}


// Render Detailed Installments Table
function renderInstallmentsTable(loans, payments) {
  const tbody = document.querySelector('#installmentsTable tbody');
  tbody.innerHTML = '';

  let totalPaid = 0;
  let totalUnpaid = 0;

  loans.forEach(loan => {
    const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;
    const unpaidWeeks = loan.weeks - paidWeeks;
    const completionPercent = ((paidWeeks / loan.weeks) * 100).toFixed(1);

    totalPaid += paidWeeks;
    totalUnpaid += unpaidWeeks;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${loan.borrower_id}</td>
      <td>${loan.borrower}</td>
      <td>${loan.weeks}</td>
      <td>${paidWeeks}</td>
      <td>${unpaidWeeks}</td>
      <td>${completionPercent}%</td>
    `;
    tbody.appendChild(tr);
  });

  // Update summary boxes
  const completionRate = totalPaid + totalUnpaid > 0 ? ((totalPaid / (totalPaid + totalUnpaid)) * 100).toFixed(1) : 0;
  document.getElementById('total-paid-installments').textContent = totalPaid;
  document.getElementById('total-unpaid-installments').textContent = totalUnpaid;
  document.getElementById('completion-rate').textContent = completionRate + '%';
}

// Check Overdue Payments
async function checkOverdue() {
  const checkDate = new Date(document.getElementById('overdue-date').value);
  const loansRes = await fetch(`${API_URL}/api/loans`);
  const loans = await loansRes.json();
  const paymentsRes = await fetch(`${API_URL}/api/payments`);
  const payments = await paymentsRes.json();

  const tbody = document.querySelector('#overdueTable tbody');
  tbody.innerHTML = '';

  loans.forEach(loan => {
    const paidWeeks = payments.filter(p => p.loan_id === loan.id).length;

    // Check each unpaid week if it's overdue
    for (let week = paidWeeks + 1; week <= loan.weeks; week++) {
      const dueDate = new Date(loan.start_date);
      dueDate.setDate(dueDate.getDate() + 7 * week);

      if (dueDate < checkDate) {
        const daysOverdue = Math.floor((checkDate - dueDate) / (1000 * 60 * 60 * 24));
        const weeklyAmount = (loan.amount * (1 + loan.interest/100) / loan.weeks);
        const outstandingAmount = weeklyAmount * (loan.weeks - paidWeeks);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${loan.borrower_id}</td>
          <td>${loan.borrower}</td>
          <td>${dueDate.toLocaleDateString('en-US')}</td>
          <td>${daysOverdue}</td>
          <td>${formatLKR(outstandingAmount)}</td>
          <td style="color: #e74c3c; font-weight: bold;">OVERDUE</td>
        `;
        tbody.appendChild(tr);
      }
    }
  });

  if (tbody.children.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="6" style="text-align: center; color: #27ae60; font-weight: bold;">No overdue payments found!</td>';
    tbody.appendChild(tr);
  }
}

window.onload = function(){
    showEnvironmentBanner();
    checkAuth();
    initAnalysis();
};

// Environment detection and banner display
function showEnvironmentBanner(){
    const hostname = window.location.hostname;
    const banner = document.getElementById('env-banner');

    // Show banner on staging/demo environments
    if (hostname.includes('staging') || hostname.includes('preview') || hostname.includes('git-') || hostname.includes('vercel-preview') ||
        (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'staging')) {
        banner.style.display = 'block';
    } else {
        banner.style.display = 'none';
    }
}

// Check authentication status
function checkAuth() {
    fetch('/api/auth/verify')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                window.location.href = '/login.html';
                return;
            }
            
            const user = data.user;
            const userNameSpan = document.getElementById('userName');
            
            if (userNameSpan) {
                userNameSpan.textContent = user.username;
            }
            
            // Show/hide admin features based on user role
            if (user.role !== 'admin') {
                window.location.href = '/index.html';
            }
        })
        .catch(error => {
            console.error('Auth check failed:', error);
            window.location.href = '/login.html';
        });
}

// Logout function
function logout() {
    fetch('/api/auth/logout', { method: 'POST' })
        .then(() => {
            window.location.href = '/login.html';
        })
        .catch(error => {
            console.error('Logout failed:', error);
            window.location.href = '/login.html';
        });
}
</script>
</body>
</html>
